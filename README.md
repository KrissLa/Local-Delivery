# Local Delivery 

## Запуск:

Для запуска бота из докера необходимо:

- установить docker, docker-compose, postgresql
- создать базу данных и пользователя базы данных
- переименовать файл .env.dist в .env и заменить в нем значения переменных окружения на действительные 
- из корня проекта запустить docker-compose up --build
## 
Для запуска без докера:

- установить python и его зависимости (бот написан на python 3.8.5)
- установить postgresql
- создать базу данных и пользователя базы данных
- установить и запустить redis
- переименовать файл .env.dist в .env и заменить в нем значения переменных окружения на действительные
- из корня проекта запустить бота командой python app.py


## .env - файл, из которого подгружаются переменные окружения:
 
- ADMIN_ID - telegramID владельца бота 
- BOT_TOKEN - токен бота, получаемый у [@BotFather](t.me/BotFather)
- ip - ip address сервера (при запуске не через docker заменить на localhost)
- PORT - порт, через который устанавливается соединение с базой данных
- PG_USER - пользователь базы данных
- PG_PASSWORD - пароль пользователя базы данных
- DB_NAME - название базы данных
- REDIS_PASS - пароль для подключения к redis
- EMAIL_USER - адрес электронной почты, к которой будут отправляться сообщения, например example@gmail.com (gmail.com)
- EMAIL_PASS - пароль от аккаунта google 


## Как это работает

<details>
<summary>Показать...</summary>

- [Первый запуск](https://vk.com/video-191823878_456239022)
- [Как сделать заказ](https://vk.com/video-191823878_456239017)
- [Продавцы](https://vk.com/video-191823878_456239023)
- [Курьеры](https://vk.com/video-191823878_456239021)
- [Курьеры оптовых заказов](https://vk.com/video-191823878_456239024)
- [Админ локации](https://vk.com/video-191823878_456239018)
- [Изменение цены в локации](https://vk.com/video-191823878_456239019)

</details>


## Структура проекта:
<details>
<summary>Показать...</summary>

- `data` - данные
    - `config.py`  - подгружает переменные из виртуального окружения и записывает их в константы<br>
- `filters` - фильтры для `обработчиков событий в боте` (далее `хэндлеры`)
    - `users_filters.py` - все фильтры, используемые в хэндлерах 
- `handlers` - все хэндлеры, используемые в боте (в порядке очереди)

    - `errors` - хэндлеры ошибок
        - `error_handler.py` - отлов некоторых ошибок
    - `inline` - хэндлеры inline режима бота
        - `share.py` - отправка приглашения другу через inline mode
    - `admin` - хэндлеры действий `администраторов` (будет редактироваться, наверно)
        - `admin_edit_delivery.py` - изменение цены оптовых товаров
        - `admin_stock` - убирираем / возвращаем категории, товары и оптовые товары из меню 
        - `admin.py` - очень много обработчиков (будет редактироваться, наверно)
        - `admin_delivery_orders.py` - обработка `администратором` оптовых закаов
        - `admin_statistics.py` - получение статистики
        - `admin_delivery_statistics.py` - получение статистики по оптовым заказам  
    - `commands` - хэндлеры команд и те, которые должны перехватываться одними из первых
        - `cancel_order.py` - ответ забаненым, отмена заказа до его отправки, кнопки отмены 
        - `admin_commands.py` - команды `администаторов` (возможно, не все)
        - `first.py` - перехват пользователей без локаций или объектов доставки  
        - `help.py` - обработчики команды /help 
        - `start.py` - регистрация в боте 
        - `seller_admin_commands.py` - команды `администраторов локаций` (возможно, не все) 
        - `sellers_commands.py` - команды `продавцов` (возможно, не все)
        - `courier_commands.py` - команды `курьеров` (возможно, не все)
        - `commands.py` - команды `покупателей` (не все)
        - `delivery_couriers_commands.py` - команды `курьеров отптовых заказов`
    - `seller_admin` - хэндлеры действий `администраторов локаций`
        - `seller_admins.py` - хэндлеры для `администраторов локаций`
        - `seller_admin_delivery_orders.py` - работа с оптовыми заказами (оформление / изменение / отмена)
        - `seller_admin_statistics.py` - получение статистики 
        - `edit_item_price_in_location.py` - изменение цены товара в локации 
    - `sellers` - хэндлеры действий `продавцов`
        - `sellers_unaccepted_orders.py` - обработка непринятых заказов
        - `sellers_active_orders.py` - обработка принятых и не готовых заказов 
        - `sellers_confirm_delivery.py` - подтверждение выдачи товара (самовывоз)
        - `sellers_bonus_orders.py` - работа с бонусными заказами (принятие / отмена / выдача)
    - `couriers` - хэндлеры действий `курьеров`
        - `couriers.py` - работа с заказами (отмена / доставка)
    - `delivery_couriers` - хэндлеры действий `курьеров оптовых заказов`
        - `delivery_courier.py` принятие / отклонение / доставка оптовых заказов
    - `users` - хэндлеры действий `клиентов` и другие
        - `cart.py` - отмена заказа, удаление товаров из корзины
        - `paginations.py` - хэндлеры кнопок пагинации 
        - `bonuses.py` - бонусные заказы
        - `profile.py` - работа с профилем 
        - `back.py` - кнопки назад при заказе 
        - `menu.py` - заказы + отзывы 
        - `echo.py` - обработка всего останого 
- `keyboards` - клавиатуры, используемые в боте
    - `default` - основные клавиатуры
        - `menu.py` - клавиатура основного меню 
    - `inline` - клавиатуры, привязанные к сообщениям бота
        - `callback_datas.py` - данные, передаваемые в callback
        - `inline_keyboards.py` - inline клавиатуры 
        -  `statistics_keyboards.py` - inline клавиатуры, для получения статистики 
- `middlewares` - промежуточные слои
    - `throttling.py` - антиспам
- `states` - состояния FSM 
    - `admin_state.py` - состояния для хэндлеров администраторов 
    - `bonus_state.py` - состояния для хэндлеров бонусных заказов 
    - `menu_states.py` - состояния для хэндлеров заказа 
    - `profile_states.py` - состояния для хэндлеров профиля
    - `seller_admin_states.py` - состояния для хэндлеров администраторов локаций
    - `sellers_states.py` - состояния для хэндлеров продавцов 
- `statistics` - директория для временного хранения файлов со статистикой перед отправкой
- `utils` - вспомогательные утилиты
    - `db_api` - модуль для работы с базами данных 
        - `postgresql.py` - класс базы данных
    - `misc` - разное
        - `logging.py` - настройка логов
        - `throttling.py` - декоратор для антиспама 
    - `check_states.py` - дополнительные действия при некоторых состояниях FSM
    - `emoji.py` - используемые в боте эмоджи
    - `get_price.py` - работа со словарями цен
    - `notify_admins.py` - сообщения `администратору` о запуске бота
    - `pagination.py` - алгоритм пагинации в клавиатурах
    - `product_list.py` - списки с `товарами`
    - `send_messages.py` - формирование и отправка некоторых сообщений
    - `set_bot_commands.py` - команды, показываемые всем в боте
    - `statistics.py` - работа со статистикой
    - `temp_orders_list.py` - формирование некоторых сообщений перед отправкой
    - `test.py` - алгоритм для заполнения базы данных тестовыми значениями (старая версия. не актуально)
- `.env (.env.dist)` - хранение переменных окружения
- `app.py` - запуск бота (устанавка filters, middlewares, команд, создание структуры базы данных)
- `loader.py` - инициализация бота, базы данных, временного хранилища данных
- `Dockerfile` - настройки для docker
- `docker-compose.yml` - настройки для контейнеров с ботом и redis 
- `requirements.txt` - используемые библиотеки и их зависимости
- `README.md`
- `.gitignore`
</details>



## Структура базы данных 

<details>
<summary>Показать...</summary>

- дополняется

</details>



 


